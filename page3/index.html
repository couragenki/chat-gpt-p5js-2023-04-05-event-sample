<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>流体シミュレーション</title>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ammo.js/0.0.1-nightly.20200707/ammo.js"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      canvas {
        touch-action-delay: none;
        touch-action: none;
        position: absolute;
        width: 100%;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <canvas id="renderCanvas"></canvas>
    <script>
      const canvas = document.getElementById('renderCanvas');
      const engine = new BABYLON.Engine(canvas, true);

      const createScene = async function () {
        const scene = new BABYLON.Scene(engine);
        const gravityVector = new BABYLON.Vector3(0, -9.81, 0);
        const physicsPlugin = new BABYLON.AmmoJSPlugin();
        scene.enablePhysics(gravityVector, physicsPlugin);

        const camera = new BABYLON.ArcRotateCamera('camera1', Math.PI / 2, Math.PI / 4, 10, BABYLON.Vector3.Zero(), scene);
        camera.setPosition(new BABYLON.Vector3(0, 5, -10));
        camera.attachControl(canvas, true);

        const light = new BABYLON.HemisphericLight('light1', new BABYLON.Vector3(0, 1, 0), scene);
        light.intensity = 0.7;

        const ground = BABYLON.Mesh.CreateGround('ground1', 20, 20, 2, scene);
        ground.position.y = -1;
        ground.physicsImpostor = new BABYLON.PhysicsImpostor(ground, BABYLON.PhysicsImpostor.BoxImpostor, { mass: 0, restitution: 0.9 }, scene);

        const particleMaterial = new BABYLON.StandardMaterial('particleMaterial', scene);
        particleMaterial.diffuseColor = new BABYLON.Color3(0.1, 0.1, 1);
        particleMaterial.specularColor = new BABYLON.Color3(0.8, 0.8, 0.8);

        const particles = [];

        const particleRadius = 0.2;
        const particleMass = 0.1;
        const particleRestitution = 0.8;

        for (let i = 0; i < 100; i++) {
          const particle = BABYLON.MeshBuilder.CreateSphere('particle' + i, { diameter: particleRadius * 2 }, scene);
          particle.material = particleMaterial;
          particle.position = new BABYLON.Vector3(Math.random() * 8 - 4, 5 + Math.random() * 3, Math.random() * 8 - 4);
          particle.physicsImpostor = new BABYLON.PhysicsImpostor(particle, BABYLON.PhysicsImpostor.SphereImpostor, { mass: particleMass, restitution: particleRestitution }, scene);
          particles.push(particle);
        }

        scene.registerBeforeRender(function () {
          for (let i = 0; i < particles.length; i++) {
            for (let j = i + 1; j < particles.length; j++) {
              const distance = BABYLON.Vector3.Distance(particles[i].position, particles[j].position);
              if (distance < particleRadius * 2) {
                const force = particles[i].position.subtract(particles[j].position).normalize().scale((particleRadius * 2 - distance) * particleMass);
                particles[i].physicsImpostor.applyForce(force, particles[i].position);
                particles[j].physicsImpostor.applyForce(force.scale(-1), particles[j].position);
              }
            }
          }
        });

        return scene;
      };

      const scene = await createScene();

      engine.runRenderLoop(function () {
        scene.render();
      });

      window.addEventListener('resize', function () {
        engine.resize();
      });
    </script>
  </body>
</html>

